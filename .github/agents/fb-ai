#!/usr/bin/env python3
"""
fb-ai - Fantasy Baseball AI Quick Command

A simple command to run sit/start analysis 30 minutes before game time.
This is a shortcut wrapper around daily_sitstart.py with smart defaults.

ALWAYS FETCHES LATEST ROSTER FROM YAHOO:
  â€¢ Every run automatically pulls your current roster from Yahoo Fantasy
  â€¢ Uses OAuth credentials from oauth2.json
  â€¢ Fetches rosters for both your leagues:
    - "I Like BIG Bunts" (Monster Island)
    - "Pure Uncut Adam West" (Gotham City Baseball)
  â€¢ Automatically detects and uses the current MLB season
  â€¢ Historical roster data saved as: yahoo_fantasy_rosters_YYYYMMDD_HHMMSS.csv

CODE ORGANIZATION:
  â€¢ All new Python scripts must go in src/scripts/
  â€¢ Streamlit components must go in src/reports/streamlit_components/
  â€¢ Streamlit reports must go in src/reports/
  â€¢ Factor analysis modules must go in src/scripts/fa/
  â€¢ Data scraping scripts must go in src/scripts/scrape/
  â€¢ Model files must go in src/models/ (catboost, xgboost, ensemble, hybrid-dc)
  â€¢ Archived/deprecated code must go in docs/robots/archive/

TESTING REQUIREMENTS:
  â€¢ Before claiming Streamlit dashboards are "ready", ALWAYS run:
    python test/test_dashboards.py
  â€¢ Verify ALL tests pass before telling user dashboards are accessible
  â€¢ If tests fail, fix issues first, then re-test
  â€¢ Only claim "ready" after confirming test suite passes

Usage:
    fb-ai                    # Run analysis for today (auto-detects mode)
    fb-ai --date 2025-09-29  # Run for specific date
    fb-ai --full             # Force full analysis with weight tuning
    fb-ai --quick            # Force quick mode (skip weight tuning)
    fb-ai --when             # Show when to run (game times)
    fb-ai --last             # Show last recommendations
    fb-ai --help             # Show help
"""

import sys
import subprocess
import os
from pathlib import Path
from datetime import datetime, time
import argparse


def get_project_root():
    """Get the project root directory"""
    # Use current working directory as project root
    # This works because fb-ai should be run from project root
    return Path.cwd()


def log_command_to_file(args):
    """Log the command invocation to docs/copilot-last-instructions.txt and docs/robots/"""
    project_root = get_project_root()
    log_file = project_root / "docs" / "copilot-last-instructions.txt"
    
    # Ensure docs directories exist
    log_file.parent.mkdir(parents=True, exist_ok=True)
    robots_dir = project_root / "docs" / "robots"
    robots_dir.mkdir(parents=True, exist_ok=True)
    
    # Build log entry
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    command_parts = ["fb-ai"]
    
    if args.date:
        command_parts.append(f"--date {args.date}")
    if args.full:
        command_parts.append("--full")
    if args.quick:
        command_parts.append("--quick")
    if args.when:
        command_parts.append("--when")
    if args.last:
        command_parts.append("--last")
    if args.help:
        command_parts.append("--help")
    
    command = " ".join(command_parts)
    
    log_entry = f"""
{'='*80}
Timestamp: {timestamp}
Command: {command}

GITHUB COPILOT CLI INSTRUCTIONS:
When you think we have hit a major milestone and I have confirmed everything 
is working, then git add, commit, and push the current code with a descriptive 
commit message summarizing the milestone achieved.

Milestones include:
- Major feature completion (new factor analysis, new dashboard section)
- Significant refactoring (modularization, architecture improvements)
- Bug fixes that resolve critical issues
- Performance improvements
- Integration of new data sources
- Completion of multi-step workflow improvements

Before committing, ensure:
âœ“ All tests pass (if applicable)
âœ“ Code is working as expected
âœ“ User has confirmed everything is functional
âœ“ Commit message is descriptive and explains the milestone

{'='*80}
"""
    
    # Append to log file
    with open(log_file, 'a') as f:
        f.write(log_entry)
    
    # Create timestamped documentation in robots folder
    timestamp_str = datetime.now().strftime("%Y%m%d_%H%M%S")
    robot_doc = robots_dir / f"fb-ai_memory_{timestamp_str}.md"
    
    with open(robot_doc, 'w') as f:
        f.write(f"# FB-AI Command Memory\n\n")
        f.write(f"**Timestamp:** {timestamp}\n\n")
        f.write(f"**Command:** `{command}`\n\n")
        f.write(f"## Context\n\n")
        f.write(f"This document captures the state and context of this fb-ai execution.\n\n")
        f.write(f"## Instructions for GitHub Copilot CLI\n\n")
        f.write(f"When you think we have hit a major milestone and I have confirmed everything\n")
        f.write(f"is working, then git add, commit, and push the current code with a descriptive\n")
        f.write(f"commit message summarizing the milestone achieved.\n\n")
        f.write(f"### Milestones include:\n")
        f.write(f"- Major feature completion (new factor analysis, new dashboard section)\n")
        f.write(f"- Significant refactoring (modularization, architecture improvements)\n")
        f.write(f"- Bug fixes that resolve critical issues\n")
        f.write(f"- Performance improvements\n")
        f.write(f"- Integration of new data sources\n")
        f.write(f"- Completion of multi-step workflow improvements\n\n")
        f.write(f"### Before committing, ensure:\n")
        f.write(f"- âœ“ All tests pass (if applicable)\n")
        f.write(f"- âœ“ Code is working as expected\n")
        f.write(f"- âœ“ User has confirmed everything is functional\n")
        f.write(f"- âœ“ Commit message is descriptive and explains the milestone\n\n")
        f.write(f"## Next Steps\n\n")
        f.write(f"_Document any follow-up tasks or notes here_\n")
    
    return log_file


def show_when_to_run():
    """Show game times and when to run"""
    print("\nðŸ• Checking game schedule...\n")
    
    script = get_project_root() / "src" / "scripts" / "schedule_helper.py"
    
    subprocess.run([
        sys.executable,
        str(script)
    ])


def show_last_recommendations():
    """Show the most recent recommendations"""
    data_dir = get_project_root() / "data"
    
    # Find most recent recommendations file
    rec_files = sorted(
        data_dir.glob("sitstart_recommendations_*.csv"),
        key=lambda x: x.stat().st_mtime,
        reverse=True
    )
    
    if not rec_files:
        print("\nâŒ No recommendations found yet.")
        print("   Run 'fb-ai' to generate recommendations.\n")
        return
    
    latest = rec_files[0]
    file_time = datetime.fromtimestamp(latest.stat().st_mtime)
    
    print("\n" + "="*80)
    print(f"LATEST RECOMMENDATIONS - {file_time.strftime('%Y-%m-%d %I:%M %p')}")
    print("="*80 + "\n")
    
    # Read and display recommendations
    import pandas as pd
    df = pd.read_csv(latest)
    
    if 'final_score' in df.columns:
        df = df.sort_values('final_score', ascending=False)
        
        # Show top 5 starts and bottom 5 sits
        print("ðŸŒŸ TOP 5 STARTS:")
        print("-" * 80)
        for idx, row in df.head(5).iterrows():
            name = row.get('player_name', 'Unknown')
            score = row.get('final_score', 0)
            rec = row.get('recommendation', 'N/A')
            print(f"  {score:>6.2f}  {name:<30}  {rec}")
        
        print("\nðŸš« BOTTOM 5 SITS:")
        print("-" * 80)
        for idx, row in df.tail(5).iterrows():
            name = row.get('player_name', 'Unknown')
            score = row.get('final_score', 0)
            rec = row.get('recommendation', 'N/A')
            print(f"  {score:>6.2f}  {name:<30}  {rec}")
        
        print("\n" + "="*80)
        print(f"ðŸ“ Full details: {latest.name}")
        print("="*80 + "\n")
    else:
        print(f"ðŸ“ Recommendations file: {latest.name}")
        print("   (View with: cat data/{})".format(latest.name))


def auto_detect_mode():
    """Automatically detect if we should use quick or full mode based on time"""
    current_time = datetime.now().time()
    
    # If it's early (before 10 AM), use full mode
    # If it's later (close to game time), use quick mode
    if current_time < time(10, 0):
        return "full"
    else:
        return "quick"


def run_analysis(mode="auto", target_date=None):
    """Run the sit/start analysis"""
    
    script = get_project_root() / "src" / "scripts" / "daily_sitstart.py"
    
    # Build command
    cmd = [sys.executable, str(script)]
    
    # Add date if specified
    if target_date:
        cmd.extend(["--date", target_date])
    
    # Determine mode
    if mode == "auto":
        mode = auto_detect_mode()
    
    # Add mode flag
    if mode == "quick":
        cmd.append("--skip-tune")
        mode_name = "QUICK MODE (no weight tuning)"
        time_est = "1-2 minutes"
    else:
        mode_name = "FULL MODE (with weight tuning)"
        time_est = "3-5 minutes"
    
    # Display header
    print("\n" + "="*80)
    print("âš¾ FANTASY BASEBALL AI - SIT/START ANALYSIS".center(80))
    print("="*80 + "\n")
    
    print(f"Mode: {mode_name}")
    print(f"Estimated time: {time_est}")
    
    if target_date:
        print(f"Target date: {target_date}")
    else:
        print(f"Target date: Today ({datetime.now().strftime('%Y-%m-%d')})")
    
    print("\n" + "="*80 + "\n")
    
    # Run the script
    try:
        result = subprocess.run(cmd, check=True)
        
        # Show last recommendations after completion
        print("\n" + "="*80)
        print("âœ… ANALYSIS COMPLETE - QUICK SUMMARY".center(80))
        print("="*80)
        
        show_last_recommendations()
        
        return result.returncode
        
    except subprocess.CalledProcessError as e:
        print(f"\nâŒ Analysis failed with error code {e.returncode}")
        return e.returncode
    except KeyboardInterrupt:
        print("\n\nâš ï¸  Analysis interrupted by user")
        return 1


def print_help():
    """Print help message"""
    print("""
fb-ai - Fantasy Baseball AI Quick Command
==========================================

Run sit/start analysis 30 minutes before game time.

ðŸ”„ AUTOMATIC ROSTER FETCHING:
    Every run automatically pulls your latest roster from Yahoo Fantasy!
    â€¢ Fetches both leagues: "I Like BIG Bunts" & "Pure Uncut Adam West"
    â€¢ Uses current season rosters
    â€¢ Saves historical snapshots: yahoo_fantasy_rosters_YYYYMMDD_HHMMSS.csv
    â€¢ OAuth credentials from: oauth2.json

USAGE:
    fb-ai                    Run analysis for today (auto mode)
    fb-ai --date 2025-09-29  Run for specific date
    fb-ai --full             Force full analysis with weight tuning (3-5 min)
    fb-ai --quick            Force quick mode, skip weight tuning (1-2 min)
    fb-ai --when             Show when to run (game times)
    fb-ai --last             Show last recommendations
    fb-ai --help             Show this help

AUTO MODE:
    Before 10 AM: Uses full mode (with weight tuning)
    After 10 AM:  Uses quick mode (skip weight tuning for speed)

WORKFLOW:
    1. Run 'fb-ai --when' in the morning to see game times
    2. Run 'fb-ai' 30 minutes before first game
    3. Script automatically:
       - Fetches your latest roster from Yahoo
       - Updates MLB data and weather
       - Runs all 20 factor analyses
       - Generates personalized recommendations
    4. Review recommendations and set your lineup

EXAMPLES:
    # Morning: Check when games start
    $ fb-ai --when

    # 30 mins before games: Run analysis
    $ fb-ai

    # Quick mode for last-minute decisions
    $ fb-ai --quick

    # Check yesterday's recommendations
    $ fb-ai --last

    # Run for specific date (postseason)
    $ fb-ai --date 2025-10-15

FACTOR ANALYSES (20 Total):
    The pipeline analyzes 20 different factors for each player:
    
    Core Factors (High Impact):
    â€¢ Vegas Odds (11%) ðŸ†•ðŸ”¥         â€¢ Historical Matchup (10%)
    â€¢ Home/Away Venue (8%)          â€¢ Injury/Recovery (8%)
    
    Strategic Factors (Medium Impact):
    â€¢ Platoon Advantage (7%)        â€¢ Bullpen Fatigue (7%)
    â€¢ Statcast Metrics (7%)         â€¢ Wind Analysis (6%)
    â€¢ Park Factors (6%)             â€¢ Recent Form (6%)
    
    Fine-Tuning Factors (Low Impact):
    â€¢ Rest Day Impact (4%)          â€¢ Umpire Strike Zone (3%)
    â€¢ Temperature (3%)              â€¢ Pitch Mix (3%)
    â€¢ Lineup Position (3%)
    
    Supporting Factors:
    â€¢ Time of Day (2%)              â€¢ Defensive Positions (2%)
    â€¢ Humidity & Elevation (2%)     â€¢ Monthly Splits (1%)
    â€¢ Team Momentum (1%)
    
    ðŸ†• NEW: Vegas Odds (15-20% improvement) ðŸ”¥
        Over/Under totals predict scoring environment
        Implied team run totals from moneyline
        Vegas is highly accurate at predicting outcomes
        FREE via The Odds API

OUTPUT:
    Primary file: data/sitstart_recommendations_YYYYMMDD_HHMMSS.csv
    
    Scores range from -2.0 to +2.0:
        +1.5 to +2.0  ðŸŒŸ VERY FAVORABLE - Strong start
        +0.5 to +1.5  âœ… FAVORABLE - Start
        -0.5 to +0.5  âš–ï¸  NEUTRAL - Consider matchup
        -1.5 to -0.5  âš ï¸  UNFAVORABLE - Consider bench
        -2.0 to -1.5  ðŸš« VERY UNFAVORABLE - Bench

For more details, see: README.md or docs/DAILY_WORKFLOW.md
    """)


def main():
    parser = argparse.ArgumentParser(
        description='Fantasy Baseball AI - Quick Sit/Start Analysis',
        add_help=False
    )
    
    parser.add_argument('--date', type=str, help='Target date (YYYY-MM-DD)')
    parser.add_argument('--full', action='store_true', help='Force full mode with weight tuning')
    parser.add_argument('--quick', action='store_true', help='Force quick mode (skip weight tuning)')
    parser.add_argument('--when', action='store_true', help='Show game times and when to run')
    parser.add_argument('--last', action='store_true', help='Show last recommendations')
    parser.add_argument('--help', '-h', action='store_true', help='Show help')
    
    args = parser.parse_args()
    
    # Log this command execution (do it first)
    try:
        log_file = log_command_to_file(args)
        # Only show if not help command (keep help clean)
        if not args.help:
            print(f"ðŸ“ Command logged to: docs/copilot-last-instructions.txt")
    except Exception as e:
        # Don't fail if logging fails
        pass
    
    # Handle special commands
    if args.help:
        print_help()
        return 0
    
    if args.when:
        show_when_to_run()
        return 0
    
    if args.last:
        show_last_recommendations()
        return 0
    
    # Determine mode
    if args.full:
        mode = "full"
    elif args.quick:
        mode = "quick"
    else:
        mode = "auto"
    
    # Run analysis
    return run_analysis(mode=mode, target_date=args.date)


if __name__ == "__main__":
    sys.exit(main())
